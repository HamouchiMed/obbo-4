<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client - Détails</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="h-screen bg-gray-100 font-sans text-gray-800">
  <div class="flex h-full">
    <aside class="w-64 bg-gradient-to-b from-green-700 to-green-600 text-white p-6 flex flex-col">
      <div class="text-2xl font-bold mb-6">Obbo</div>
      <nav class="flex-1">
        <a class="block py-2 px-3 rounded hover:bg-white/10 mb-1" href="index.html">Dashboards</a>
        <a class="block py-2 px-3 rounded hover:bg-white/10 mb-1" href="merchants.html">Commerçants</a>
        <a class="block py-2 px-3 rounded hover:bg-white/10 mb-1" href="orders.html">Commandes</a>
        <a class="block py-2 px-3 rounded hover:bg-white/10 mb-1" href="users.html">Utilisateurs</a>
        <a class="block py-2 px-3 rounded bg-white/10 mb-1" href="clients.html">Clients</a>
      </nav>
      <div class="mt-6 text-sm opacity-90">Admin • Obbo</div>
    </aside>

    <div class="flex-1 p-6 overflow-auto">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 id="clientName" class="text-2xl font-semibold">Client</h1>
          <p id="clientSub" class="text-sm text-gray-600">Activité et KPIs</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="clients.html" class="px-3 py-2 bg-white text-green-700 rounded">Retour</a>
        </div>
      </header>

      <div id="main" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Activité récente</h3>
          <ul id="activityList" class="space-y-2 text-sm text-gray-700 max-h-48 overflow-auto"></ul>

          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">Interactions avec les commerçants</h4>
              <select id="dealerFilter" class="border p-1 rounded text-sm">
                <option value="all">Tous les commerçants</option>
              </select>
            </div>
            <ul id="interactions" class="space-y-2 text-sm text-gray-700 max-h-56 overflow-auto"></ul>
          </div>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">KPIs</h3>
          <div class="text-sm text-gray-500">Montant total</div>
          <div id="totalAmount" class="text-xl font-bold mb-2">-</div>
          <div class="text-sm text-gray-500">Commandes</div>
          <div id="ordersCount" class="text-lg font-medium mb-2">-</div>
          <canvas id="clientChart" height="64" class="w-full h-16"></canvas>
        </div>
      </div>

      <footer class="mt-6 text-sm text-gray-500">© Obbo - Admin</footer>
    </div>
  </div>

  <script>
    function qs(name){ return new URLSearchParams(window.location.search).get(name); }
    function mockClientFromId(id){
      const idx = parseInt(id.replace(/[^0-9]/g,''),10) || 1;
      return { id, name: `Client ${idx}`, email: `client${idx}@example.com` };
    }

    (function(){
      const id = qs('id');
      if(!id){ document.getElementById('main').innerHTML = '<div class="text-red-600">Aucun identifiant fourni.</div>'; return; }
      const c = mockClientFromId(id);
      document.getElementById('clientName').textContent = c.name;
      document.getElementById('clientSub').textContent = c.email;

      // mock activities
      const acts = [];
      const verbs = ['placed order','opened app','used coupon','left review','contacted support'];
      for(let i=0;i<12;i++) acts.push({time: new Date(Date.now() - i*3600*1000).toISOString(), text: verbs[Math.floor(Math.random()*verbs.length)]});
      const list = document.getElementById('activityList');
      acts.forEach(a=>{
        const li = document.createElement('li');
        li.className = 'bg-gray-50 p-2 rounded';
        li.textContent = `${new Date(a.time).toLocaleString()}: ${a.text}`;
        list.appendChild(li);
      });

      // mock dealers and interactions
      const dealers = [ {id:'d1', name:'Boulangerie Zen'}, {id:'d2', name:'Épicerie Atlas'}, {id:'d3', name:'Café Central'} ];
      // populate dealer filter
      const dealerFilter = document.getElementById('dealerFilter');
      dealers.forEach(d=>{ const opt = document.createElement('option'); opt.value = d.id; opt.textContent = d.name; dealerFilter.appendChild(opt); });

      // generate interactions between client and dealers
      const interactions = [];
      for(let i=0;i<18;i++){
        const dealer = dealers[Math.floor(Math.random()*dealers.length)];
        const isDealer = Math.random() > 0.5;
        interactions.push({
          time: new Date(Date.now() - Math.floor(Math.random()*10*24*3600*1000)).toISOString(),
          dealerId: dealer.id,
          dealerName: dealer.name,
          from: isDealer ? 'dealer' : 'client',
          text: isDealer ? 'Réponse du commerçant: merci pour votre commande' : 'Message client: question sur produit'
        });
      }

      function renderInteractions(filterId){
        const container = document.getElementById('interactions');
        container.innerHTML = '';
        const filtered = interactions.filter(it => filterId === 'all' ? true : it.dealerId === filterId);
        filtered.sort((a,b)=> new Date(b.time) - new Date(a.time));
        filtered.forEach(it=>{
          const li = document.createElement('li');
          li.className = 'p-2 rounded ' + (it.from==='dealer' ? 'bg-green-50' : 'bg-gray-50');
          li.innerHTML = `<div class="text-sm text-gray-600">${it.dealerName} • ${new Date(it.time).toLocaleString()}</div><div class="mt-1">${it.text}</div>`;
          container.appendChild(li);
        });
      }

      dealerFilter.addEventListener('change', (e)=> renderInteractions(e.target.value));
      renderInteractions('all');

      // mock KPIs and chart
      const series = Array.from({length:30}, (_,i)=> Math.round(100 + Math.random()*400 + i*3));
      document.getElementById('totalAmount').textContent = new Intl.NumberFormat('fr-FR').format(series.reduce((a,b)=>a+b,0)) + ' DH';
      document.getElementById('ordersCount').textContent = Math.floor(5 + Math.random()*50);

  const ctx = document.getElementById('clientChart').getContext('2d');
  new Chart(ctx, { type:'line', data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor:'#16a34a', backgroundColor:'rgba(16,163,74,0.06)', fill:true, pointRadius:0 }] }, options:{ responsive:true, maintainAspectRatio:true, aspectRatio:4, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{borderWidth:1.5}} } });
    })();
  </script>
</body>
</html>
